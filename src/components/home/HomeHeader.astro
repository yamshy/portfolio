---
import ThemeToggle from '../ui/ThemeToggle.svelte';

const navLinks = [
  { label: 'Overview', href: '#hero' },
  { label: 'Projects', href: '#projects' },
  { label: 'Skills', href: '#skills' },
  { label: 'Experience', href: '#experience' },
  { label: 'Insights', href: '#insights' },
  { label: 'Contact', href: '#contact' },
];
---

<header class="site-header" data-reveal data-js="site-header">
  <div class="site-header__inner u-container">
    <button
      class="site-nav__toggle"
      type="button"
      aria-expanded="false"
      aria-controls="primary-navigation"
      aria-label="Open navigation menu"
      data-js="nav-toggle"
      data-state="closed"
    >
      <span class="site-nav__toggle-icon" aria-hidden="true">
        <span class="site-nav__toggle-line"></span>
        <span class="site-nav__toggle-line"></span>
        <span class="site-nav__toggle-line"></span>
      </span>
      <span class="site-nav__toggle-label" data-js="nav-toggle-label">Menu</span
      >
    </button>
    <nav
      id="primary-navigation"
      class="site-nav"
      aria-label="Primary navigation"
      data-js="primary-navigation"
      data-state="open"
    >
      {
        navLinks.map((link) => (
          <a class="site-nav__link" href={link.href}>
            {link.label}
          </a>
        ))
      }
      <div class="site-nav__theme-toggle-wrapper" data-js="mobile-theme-target">
      </div>
    </nav>
    <div
      class="site-header__theme-toggle-wrapper"
      data-js="desktop-theme-target"
    >
      <div class="site-header__theme-toggle" data-js="theme-toggle">
        <ThemeToggle client:idle />
      </div>
    </div>
  </div>
</header>

<style>
  .site-header {
    background: color-mix(
      in oklab,
      var(--color-surface-strong) 35%,
      var(--color-surface) 65%
    );
    border-bottom: 1px solid var(--color-border);
    position: relative;
    z-index: 10;
  }

  .site-header__inner {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--space-md);
    padding-block: clamp(var(--space-2xs), 1.2vw, var(--space-sm));
    flex-wrap: wrap;
    position: relative;
  }

  .site-nav {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: clamp(var(--space-2xs), 1.6vw, var(--space-sm));
  }

  .site-nav__link {
    display: inline-flex;
    align-items: center;
    font-family: var(--font-serif);
    font-size: var(--text-md);
    font-weight: 500;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    padding-block: 0.25rem;
    padding-inline: 0.35rem;
    color: color-mix(
      in oklab,
      var(--color-text) 82%,
      var(--color-text-muted) 18%
    );
    transition: color var(--duration-base) var(--ease-smooth);
  }

  .site-nav__link:hover,
  .site-nav__link:focus-visible {
    color: var(--color-primary-strong);
    text-decoration-thickness: 2px;
    text-underline-offset: 4px;
  }

  .site-nav__toggle {
    display: none;
  }

  .site-nav__toggle-icon {
    display: inline-flex;
    position: relative;
    width: 1.25rem;
    height: 1rem;
    margin-inline-end: 0.35rem;
  }

  .site-nav__toggle-line {
    position: absolute;
    inset-inline: 0;
    height: 2px;
    border-radius: 999px;
    background: currentColor;
    transition:
      transform var(--duration-base) var(--ease-smooth),
      opacity var(--duration-base) var(--ease-smooth);
  }

  .site-nav__toggle-line:nth-child(1) {
    top: 0;
  }

  .site-nav__toggle-line:nth-child(2) {
    top: calc(50% - 1px);
  }

  .site-nav__toggle-line:nth-child(3) {
    bottom: 0;
  }

  .site-nav__toggle[data-state='open'] .site-nav__toggle-line:nth-child(1) {
    transform: translateY(7px) rotate(45deg);
  }

  .site-nav__toggle[data-state='open'] .site-nav__toggle-line:nth-child(2) {
    opacity: 0;
  }

  .site-nav__toggle[data-state='open'] .site-nav__toggle-line:nth-child(3) {
    transform: translateY(-7px) rotate(-45deg);
  }

  .site-nav__toggle-label {
    font-family: var(--font-sans);
    font-size: var(--text-sm);
    letter-spacing: 0.12em;
    text-transform: uppercase;
  }

  .site-header__theme-toggle-wrapper {
    display: flex;
    align-items: center;
  }

  .site-header__theme-toggle {
    display: flex;
  }

  .site-nav__theme-toggle-wrapper {
    display: none;
  }

  :global(body.has-mobile-nav-open) {
    overflow: hidden;
  }

  @media (max-width: 48rem) {
    .site-header__inner {
      flex-wrap: nowrap;
      align-items: center;
    }

    .site-nav {
      position: absolute;
      top: calc(100% + var(--space-xs));
      right: 0;
      left: 0;
      flex-direction: column;
      align-items: flex-start;
      gap: clamp(var(--space-2xs), 2.6vw, var(--space-sm));
      padding: clamp(var(--space-sm), 4vw, var(--space-lg));
      border-radius: var(--radius-md);
      background: color-mix(
        in oklab,
        var(--color-surface-strong) 92%,
        var(--color-surface) 8%
      );
      border: 1px solid
        color-mix(in oklab, var(--color-border) 78%, transparent 22%);
      box-shadow: 0 24px 36px -22px
        color-mix(
          in oklab,
          var(--color-shadow, rgba(32, 22, 17, 0.65)) 45%,
          transparent 55%
        );
      opacity: 1;
      visibility: visible;
      pointer-events: auto;
      transform: translateY(0);
      transition:
        opacity var(--duration-base) var(--ease-smooth),
        transform var(--duration-base) var(--ease-smooth),
        visibility 0s linear;
      z-index: 5;
    }

    .site-nav[data-state='closed'] {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      transform: translateY(-0.5rem);
      transition:
        opacity var(--duration-base) var(--ease-smooth),
        transform var(--duration-base) var(--ease-smooth),
        visibility 0s linear var(--duration-base);
    }

    .site-nav__link {
      width: 100%;
      font-size: clamp(var(--text-md), 4.2vw, var(--text-lg));
      justify-content: space-between;
    }

    .site-nav__toggle {
      display: inline-flex;
      align-items: center;
      gap: var(--space-3xs);
      border: 1px solid
        color-mix(in oklab, var(--color-border) 65%, transparent 35%);
      border-radius: var(--radius-sm);
      padding-inline: clamp(var(--space-xs), 3vw, var(--space-sm));
      padding-block: 0.4rem;
      background: color-mix(
        in oklab,
        var(--color-surface-strong) 65%,
        var(--color-surface) 35%
      );
      color: var(--color-text);
      cursor: pointer;
      transition:
        background var(--duration-base) var(--ease-smooth),
        transform var(--duration-base) var(--ease-smooth);
      order: 3;
      margin-inline-start: auto;
    }

    .site-nav__toggle:hover,
    .site-nav__toggle:focus-visible {
      background: color-mix(
        in oklab,
        var(--color-surface-strong) 75%,
        var(--color-surface) 25%
      );
      transform: translateY(-1px);
    }

    .site-header__theme-toggle-wrapper {
      display: none;
    }

    .site-nav__theme-toggle-wrapper {
      display: flex;
      width: 100%;
      padding-top: clamp(var(--space-xs), 3vw, var(--space-md));
      border-top: 1px solid
        color-mix(in oklab, var(--color-border) 65%, transparent 35%);
    }

    .site-nav__theme-toggle-wrapper :global(.toggle) {
      width: 100%;
      justify-content: space-between;
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .site-nav,
    .site-nav[data-state='closed'],
    .site-nav__toggle-line,
    .site-nav__toggle {
      transition: none !important;
      transform: none !important;
    }
  }
</style>

<script is:inline>
  const DESKTOP_BREAKPOINT = '(min-width: 48rem)';

  const setupMobileNav = () => {
    const header = document.querySelector('[data-js="site-header"]');

    if (!header || header.dataset.mobileNavReady === 'true') {
      return;
    }

    const nav = header.querySelector('[data-js="primary-navigation"]');
    const toggle = header.querySelector('[data-js="nav-toggle"]');
    const navLabel = header.querySelector('[data-js="nav-toggle-label"]');

    if (!nav || !toggle) {
      return;
    }

    header.dataset.mobileNavReady = 'true';

    const linkElements = Array.from(nav.querySelectorAll('a'));
    const desktopThemeTarget = header.querySelector(
      '[data-js="desktop-theme-target"]',
    );
    const mobileThemeTarget = header.querySelector(
      '[data-js="mobile-theme-target"]',
    );
    const themeToggle = header.querySelector('[data-js="theme-toggle"]');
    const desktopQuery = window.matchMedia(DESKTOP_BREAKPOINT);

    let isOpen = false;

    const updateThemeTogglePlacement = () => {
      if (!themeToggle || !desktopThemeTarget || !mobileThemeTarget) {
        return;
      }

      if (desktopQuery.matches) {
        desktopThemeTarget.appendChild(themeToggle);
      } else {
        mobileThemeTarget.appendChild(themeToggle);
      }
    };

    const updateNavState = (open) => {
      const isDesktop = desktopQuery.matches;

      updateThemeTogglePlacement();

      if (isDesktop) {
        nav.dataset.state = 'open';
        toggle.dataset.state = 'closed';
        toggle.setAttribute('aria-expanded', 'false');
        toggle.setAttribute('aria-label', 'Open navigation menu');
        if (navLabel) {
          navLabel.textContent = 'Menu';
        }
        nav.removeAttribute('aria-hidden');
        document.body.classList.remove('has-mobile-nav-open');
        return;
      }

      nav.dataset.state = open ? 'open' : 'closed';
      toggle.dataset.state = open ? 'open' : 'closed';
      toggle.setAttribute('aria-expanded', open ? 'true' : 'false');
      toggle.setAttribute(
        'aria-label',
        open ? 'Close navigation menu' : 'Open navigation menu',
      );

      if (navLabel) {
        navLabel.textContent = open ? 'Close' : 'Menu';
      }

      if (open) {
        nav.setAttribute('aria-hidden', 'false');
        document.body.classList.add('has-mobile-nav-open');
      } else {
        nav.setAttribute('aria-hidden', 'true');
        document.body.classList.remove('has-mobile-nav-open');
      }
    };

    const openNav = () => {
      isOpen = true;
      updateNavState(isOpen);
    };

    const closeNav = () => {
      isOpen = false;
      updateNavState(isOpen);
    };

    const onToggle = () => {
      if (isOpen) {
        closeNav();
      } else {
        openNav();
      }
    };

    const onKeydown = (event) => {
      if (event.key === 'Escape') {
        closeNav();
      }
    };

    const handleDesktopChange = (event) => {
      if (event.matches) {
        isOpen = false;
        updateNavState(isOpen);
      } else {
        updateNavState(isOpen);
      }
    };

    toggle.addEventListener('click', onToggle);
    window.addEventListener('keydown', onKeydown);
    linkElements.forEach((link) => {
      link.addEventListener('click', closeNav);
    });

    if (typeof desktopQuery.addEventListener === 'function') {
      desktopQuery.addEventListener('change', handleDesktopChange);
    }

    updateNavState(isOpen);

    const cleanup = () => {
      closeNav();
      toggle.removeEventListener('click', onToggle);
      window.removeEventListener('keydown', onKeydown);
      linkElements.forEach((link) => {
        link.removeEventListener('click', closeNav);
      });
      if (typeof desktopQuery.removeEventListener === 'function') {
        desktopQuery.removeEventListener('change', handleDesktopChange);
      }
      if (themeToggle && desktopThemeTarget) {
        desktopThemeTarget.appendChild(themeToggle);
      }
      document.body.classList.remove('has-mobile-nav-open');
      delete header.dataset.mobileNavReady;
    };

    document.addEventListener('astro:before-swap', cleanup, { once: true });
  };

  setupMobileNav();
  document.addEventListener('astro:page-load', setupMobileNav);
</script>
